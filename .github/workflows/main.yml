name: OSRS F2P High Volume Flipper

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes
  workflow_dispatch:

jobs:
  run-flipper:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests pandas scikit-learn

      - name: Run OSRS Volume Flipper
        run: |
          python - << 'EOF'
          import requests
          import pandas as pd
          from sklearn.ensemble import RandomForestRegressor

          PRICE_URL = "https://prices.runescape.wiki/api/v1/osrs/latest"
          MAPPING_URL = "https://prices.runescape.wiki/api/v1/osrs/mapping"

          HEADERS = {"User-Agent": "OSRS-Volume-Flipper-GitHub"}

          def fetch(url):
              return requests.get(url, headers=HEADERS, timeout=20).json()

          print("âš¡ OSRS F2P HIGH-VOLUME FLIPPER (GitHub Actions)")
          print("ðŸ“Š Volume > Margin\n")

          mapping = pd.DataFrame(fetch(MAPPING_URL))
          mapping = mapping[mapping["members"] == False]

          prices = fetch(PRICE_URL)["data"]
          rows = []

          for item_id, d in prices.items():
              if d.get("high") and d.get("low"):
                  rows.append({
                      "id": int(item_id),
                      "buy": d["high"],
                      "sell": d["low"]
                  })

          price_df = pd.DataFrame(rows)
          df = mapping.merge(price_df, on="id")

          df["profit_per_item"] = df["buy"] - df["sell"]
          df["margin_pct"] = (df["profit_per_item"] / df["sell"]) * 100

          df = df[
              (df["profit_per_item"] >= 3) &
              (df["limit"] >= 1000) &
              (df["sell"] <= 200000)
          ]

          if df.empty:
              print("âŒ No valid items this run.")
              exit()

          df["expected_units_per_hour"] = (
              (df["limit"] / 4) *
              (1 / (df["margin_pct"].abs() + 1))
          )

          features = df[
              ["profit_per_item", "margin_pct", "limit", "expected_units_per_hour"]
          ]
          target = df["expected_units_per_hour"]

          model = RandomForestRegressor(
              n_estimators=150,
              max_depth=7,
              random_state=42
          )
          model.fit(features, target)

          df["predicted_units_per_hour"] = model.predict(features)
          df["estimated_gp_per_hour"] = (
              df["predicted_units_per_hour"] * df["profit_per_item"]
          )

          df = df.sort_values("estimated_gp_per_hour", ascending=False)

          print("\nðŸ”¥ TOP F2P HIGH-VOLUME FLIPS ðŸ”¥\n")
          print(df[
              [
                  "name",
                  "sell",
                  "buy",
                  "profit_per_item",
                  "limit",
                  "predicted_units_per_hour",
                  "estimated_gp_per_hour"
              ]
          ].head(15).to_string(index=False))
          EOF
          
